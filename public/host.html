<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>1-tegen-100 Host</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Banner */
    .banner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-radius: 16px;
      background: linear-gradient(135deg, #1d4ed8, #7c3aed);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.6);
    }

    .banner-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .banner-title {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .banner-subtitle {
      font-size: 0.9rem;
      opacity: 0.85;
    }

    .banner-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .game-code-pill {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(248, 250, 252, 0.7);
      font-size: 0.95rem;
      font-weight: 600;
      text-transform: uppercase;
      background: rgba(15, 23, 42, 0.2);
    }

    .btn-primary,
    .btn-secondary {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: #22c55e;
      color: #022c22;
      border: 1px solid #2b6d17;
    }
    
    .btn-primary:hover {
      background: #147a3a;
      color: #022c22;
      border-color: #7c3aed; 
    }

    .btn-secondary {
      background: #020617;      
      color: #e5e7eb;          
      border: 1px solid #4c1d95;
    }

    .btn-secondary:hover {
      background: #111827;    
      border-color: #7c3aed; 
    }

    .btn-danger {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #7f1d1d;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      background: #b91c1c;
      color: #fee2e2;
    }

    .btn-danger:hover {
      background: #991b1b;
    }

    /* Layout main area */
    .main {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr)); /* 50 / 50 verdeling */
      gap: 12px;
      align-items: start;
    }

    @media (max-width: 900px) {
      body {
        padding: 8px;
      }
      .main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid #1e293b;
      padding: 12px 14px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.6);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.8;
    }

    .card-meta {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    .card-footer {
      margin-top: 8px;
      display: flex;
      justify-content: center;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .stat {
      background: #0b1120;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stat-label {
      font-size: 0.75rem;
      opacity: 0.75;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .stat-value {
      font-size: 2.1rem;
      font-weight: 700;
    }

    /* Vragenbord */
    #questionGrid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .question-tile {
      border-radius: 12px;
      padding: 8px 6px;
      text-align: center;
      font-size: 0.8rem;
      cursor: pointer;
      border: 1px solid #1f2937;
      background: #020617;
      transition: transform 0.05s ease, box-shadow 0.05s ease, border-color 0.05s ease, background 0.05s ease;
      height: 70px;           
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 3px;
      overflow: hidden;
      white-space: nowrap;
    }

    .question-tile strong,
    .question-tile small {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 100%;
      display: block;
    }

    .question-tile:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.7);
      border-color: #3b82f6;
    }

    .question-tile.used {
      background: #111827;
      border-style: dashed;
      border-color: #4b5563;
      opacity: 0.6;
      cursor: not-allowed;
    }

    .question-tile.active {
      border-color: #fbbf24;
      box-shadow: 0 0 0 1px #fbbf24;
    }

    /* Difficulty kleuren */
    .question-tile.easy {
      background-color: #052e16;
      border-color: #16a34a;
    }

    .question-tile.medium {
      background-color: #451a03;
      border-color: #f59e0b;
    }

    .question-tile.hard {
      background-color: #450a0a;
      border-color: #ef4444;
    }

    .question-tile.used.easy,
    .question-tile.used.medium,
    .question-tile.used.hard {
      background-color: #111827;
      border-color: #4b5563;
    }

    /* Huidige vraag / resultaten */
    #currentQuestionText {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    #currentQuestionInfo {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    #currentQuestionOptions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
    }

    .option-row {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
    }

    .option-row.correct {
      border-color: #22c55e;
      background: #052e16;
    }

    .option-label {
      opacity: 0.8;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .option-text {
      font-size: 0.9rem;
    }

    /* Players kaart */
    #playerList {
      list-style: none;
      margin-top: 6px;
      max-height: 280px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.9rem;
    }

    #playerList li {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid rgba(15, 23, 42, 0.8);
    }

    .player-name {
      font-weight: 500;
    }

    .player-status {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .player-status.alive {
      color: #22c55e;
    }

    .player-status.out {
      color: #f97373;
    }

    #playerGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
      gap: 6px;
      margin-top: 6px;
      max-height: 280px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .player-square {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      cursor: default;
      border: 1px solid #1f2937;
    }

    .player-square.alive {
      background: #052e16;
      border-color: #16a34a;
      color: #22c55e;
    }

    .player-square.out {
      background: #450a0a;
      border-color: #ef4444;
      color: #ef4444;
    }

    .player-square:hover {
      filter: brightness(1.2);
    }

    /* Footer row (bottom cards) */
    .bottom-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (max-width: 900px) {
      .bottom-row {
        grid-template-columns: 1fr;
      }
    }

    #gameOverMsg {
      font-size: 0.95rem;
    }

    /* Winner overlay */
    #winnerOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;              /* standaard verborgen */
      align-items: center;
      justify-content: center;
      z-index: 2000;              /* boven alles */
    }

    .winner-modal {
      background: #020617;
      padding: 24px 32px;
      border-radius: 24px;
      border: 1px solid #4b5563;
      box-shadow: 0 25px 70px rgba(15, 23, 42, 0.9);
      max-width: 480px;
      width: 90%;
      text-align: center;
    }

    .winner-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    #winnerTitle {
      font-size: 1.8rem;
      font-weight: 800;
      margin-bottom: 8px;
    }

    #winnerNameLine {
      font-size: 1.4rem;
      font-weight: 700;
      color: #22c55e;
      margin-bottom: 8px;
    }

    #winnerReason {
      font-size: 0.95rem;
      opacity: 0.85;
      margin-bottom: 16px;
    }

    #winnerCloseBtn {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    #winnerCloseBtn:hover {
      background: #111827;
    }
    .category-actions {
    margin-top: 6px;
    display: none; /* wordt zichtbaar als je op de tegel klikt */
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .category-btn {
    border-radius: 999px;
    border: 1px solid transparent;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 4px 10px;
  }

  /* Groen = makkelijk */
  .category-btn.easy {
    background: #16a34a;
    border-color: #15803d;
    color: #022c22;
  }

  .category-btn.easy:hover {
    background: #22c55e;
  }

  /* Rood = moeilijk */
  .category-btn.hard {
    background: #b91c1c;
    border-color: #7f1d1d;
    color: #fee2e2;
  }

  .category-btn.hard:hover {
    background: #dc2626;
  }

  /* Gebruikte vraag dimmen */
  .category-btn.used {
    opacity: 0.5;
    cursor: not-allowed;
  }

  </style>
</head>
<body>
  <div class="app">
    <!-- Banner -->
    <header class="banner">
      <div class="banner-left">
        <div class="banner-title">1-tegen-100 Host</div>
        <div class="banner-subtitle">McCoy Synergy 2025</div>
      </div>
      <div class="banner-right">
        <div class="game-code-pill">
          Game code: <span id="gameCode">----</span>
        </div>
        <button id="btnCreate" class="btn-primary">Nieuwe game</button>
        <button id="btnManageQuestions" class="btn-secondary">Vragen beheren</button>
      </div>
    </header>

    <!-- Stats -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">Overzicht</div>
        <div class="card-meta"></div>
      </div>
        <div class="stats-row">
          <div class="stat">
            <div class="stat-label">Totaal spelers</div>
            <div class="stat-value" id="statTotalPlayers">
              0 <span id="statPlayersBreakdown" style="opacity:0.7; font-size:0.85rem;"></span>
            </div>
          </div>

          <div class="stat stat-progress" style="grid-column: span 2;">
            <div class="stat-label">Antwoord voortgang</div>
            <div id="answerProgressSummary" style="font-size:1.0rem; font-weight:700; margin-top:4px;">
              (0/0)
            </div>
            <div style="margin-top:8px;">
              <div id="progressBarContainer" style="
                width:100%; 
                height:8px; 
                background:#111827; 
                border-radius:6px;
                overflow:hidden; 
                border:1px solid #1e293b;
              ">
                <div id="progressBarFill" style="
                  height:100%; 
                  width:0%; 
                  background:#ef4444; 
                  transition:width 0.3s ease, background 0.3s ease;
                "></div>
              </div>
            </div>

            <ul id="pendingList" style="margin-top:6px; list-style:none; padding:0; font-size:0.8rem;"></ul>
          </div>
          <div class="stat">
            <div class="stat-label">Vragen gespeeld</div>
            <div class="stat-value">
              <span id="statQuestionsPlayed">0</span>/<span id="statQuestionsTotal">0</span>
            </div>
          </div>
        </div>
      </section>

    </section>

    <!-- Main area -->
    <section class="main">
      <!-- Vragenbord -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">Vragenbord</div>
          <div class="card-meta"></div>
        </div>
        <div id="questionGrid"></div>
      </section>

      <section class="card">
        <div class="card-header">
          <div class="card-title">Huidige vraag</div>
          <div class="card-meta">
            <span id="questionMeta"></span>
          </div>
        </div>

        <div id="currentQuestionText"></div>
        <div id="currentQuestionInfo"></div>
        <div id="currentQuestionOptions"></div>

        <div class="card-footer" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
          <button 
            id="btnCloseQuestionInline" 
            class="btn-primary" 
            style="display:none; padding:8px 12px; font-size:0.85rem;">
            Sluit vraag
          </button>

          <button 
            id="btnProcessAnswersInline" 
            class="btn-danger" 
            style="display:none; padding:8px 12px; font-size:0.85rem;">
            Verwerk antwoorden
          </button>
        </div>
      </section>
    </section>

    <section class="bottom-row">
      <section class="card">
        <div class="card-header">
          <div class="card-title" id="playersCardTitle">Spelers</div>
          <div class="card-meta"></div>
        </div>
        <div id="playerGrid"></div>
      </section>
    </section>
  </div>

  <!-- Winner overlay (NU vóór het script) -->
  <div id="winnerOverlay">
    <div class="winner-modal">
      <div class="winner-label">Game afgelopen</div>
      <h1 id="winnerTitle"></h1>
      <p id="winnerNameLine"></p>
      <p id="winnerReason"></p>
      <button id="winnerCloseBtn">Sluit overlay</button>
    </div>
  </div>

  <div id="questionModal" style="
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1500;
  ">
  <div style="
    background:#020617;
    padding:20px;
    border-radius:16px;
    border:1px solid #4b5563;
    max-width:600px;
    width:90%;
    box-shadow:0 20px 60px rgba(0,0,0,0.7);
    position: relative;
  ">

    <!-- Titel + AI-knop rechtsboven -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <h3 style="margin:0;">Vragen beheren</h3>
      <button id="btnCancelQuestions" class="btn-secondary" style="padding:6px 12px;">❌</button>
    </div>

    <p style="font-size:0.9rem; opacity:0.85; margin-bottom:8px;">
      Plak hier een JSON-array van vragen, of laat AI ze generenen.<br>
    </p>

    <textarea id="questionsJson" style="
      width:100%; 
      min-height:200px; 
      background:#020617; 
      color:#e5e7eb; 
      border:1px solid #1e293b;
      border-radius:8px;
      padding:8px;
      font-family: monospace;
      font-size:0.85rem;
      margin-bottom:10px;
    "></textarea>

    <!-- Knoppen onderaan -->
    <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
      <button id="btnClearQuestions" class="btn-danger" style="padding:6px 12px;">
        Alle vragen verwijderen
      </button>

      <div style="display:flex; gap:8px;">
        <button id="btnGenerateAiQuestions" class="btn-secondary" style="
          padding:6px 12px;
          font-size:0.8rem;
          border-radius:999px;
          cursor:pointer;">
          Genereer vragen
        </button>
        <button id="btnApplyQuestions" class="btn-primary" style="padding:6px 12px;">Vragen toevoegen</button>
      </div>
    </div>

    <div id="questionsFeedback" style="font-size:0.85rem; margin-top:6px; opacity:0.85;"></div>
  </div>
</div>

  <script>
    const socket = io();
    let currentGameCode = null;
    let questionsCache = [];
    let totalQuestions = 0;
    let questionsPlayed = 0;
    let playersState = [];
    const btnCreate = document.getElementById('btnCreate');
    const gameCodeSpan = document.getElementById('gameCode');
    const questionGrid = document.getElementById('questionGrid');
    const statTotalPlayers = document.getElementById('statTotalPlayers');
    const statQuestionsPlayed = document.getElementById('statQuestionsPlayed');
    const statQuestionsTotal = document.getElementById('statQuestionsTotal');
    const currentQuestionText = document.getElementById('currentQuestionText');
    const currentQuestionInfo = document.getElementById('currentQuestionInfo');
    const currentQuestionOptions = document.getElementById('currentQuestionOptions');
    const questionMeta = document.getElementById('questionMeta');
    const pendingList = document.getElementById('pendingList');
    const answerProgressSummary = document.getElementById('answerProgressSummary');
    const progressBarFill = document.getElementById('progressBarFill');
    const winnerOverlay = document.getElementById('winnerOverlay');
    const winnerTitle = document.getElementById('winnerTitle');
    const winnerNameLine = document.getElementById('winnerNameLine');
    const winnerReason = document.getElementById('winnerReason');
    const winnerCloseBtn = document.getElementById('winnerCloseBtn');
    const btnManageQuestions = document.getElementById('btnManageQuestions');
    const questionModal = document.getElementById('questionModal');
    const questionsJson = document.getElementById('questionsJson');
    const btnCancelQuestions = document.getElementById('btnCancelQuestions');
    const btnApplyQuestions = document.getElementById('btnApplyQuestions');
    const btnClearQuestions = document.getElementById('btnClearQuestions');
    const questionsFeedback = document.getElementById('questionsFeedback');
    const playersCardTitle = document.getElementById('playersCardTitle');
    const btnCloseQuestionInline = document.getElementById('btnCloseQuestionInline');
    const btnProcessAnswersInline = document.getElementById('btnProcessAnswersInline');

    winnerCloseBtn.onclick = () => {
      winnerOverlay.style.display = 'none';
    };

    function questionBankExample() {
      return [
        {
          text: "Voorbeeldvraag: Wat is 2 + 2?",
          options: ["3", "4", "5", "6"],
          correctIndex: 1,
          difficulty: "Makkelijk"
        }
      ];
    }

    // Nieuwe game met confirm
    btnCreate.onclick = () => {
      const ok = confirm(
        "Weet je zeker dat je een nieuwe game wilt starten?\nAlle spelers worden uit het huidige spel verwijderd."
      );
      if (!ok) return;

      socket.emit('host:createGame');
    };

    if (btnCloseQuestionInline) {
      btnCloseQuestionInline.onclick = () => {
        if (!currentGameCode) return;
        socket.emit('host:lockQuestion', { gameCode: currentGameCode });
      };
    }

    if (btnProcessAnswersInline) {
      btnProcessAnswersInline.onclick = () => {
        if (!currentGameCode) return;
        socket.emit('host:processAnswers', { gameCode: currentGameCode });
      };
    }

    function mapDifficultyToClass(diff) {
      if (!diff) return '';
      const d = diff.toLowerCase();
      if (d.includes('mak') || d.includes('easy')) return 'easy';
      if (d.includes('gem') || d.includes('mid') || d.includes('med')) return 'medium';
      if (d.includes('moeil') || d.includes('hard')) return 'hard';
      return '';
    }

    function updateStats() {
      const total = playersState.length;
      const alive = playersState.filter(p => p.alive).length;
      const out = total - alive;

      // Totaal spelers + breakdown (0 (alive/out))
      if (statTotalPlayers) {
        // eerste tekstnode in statTotalPlayers is de "0 "
        if (statTotalPlayers.firstChild) {
          statTotalPlayers.firstChild.textContent = `${total} `;
        } else {
          statTotalPlayers.textContent = `${total} `;
        }
      }

      const breakdown = document.getElementById('statPlayersBreakdown');
      if (breakdown) {
        breakdown.textContent = `(${alive}/${out})`;
      }

      // Titel boven spelers-grid
      if (playersCardTitle) {
        playersCardTitle.textContent = `Spelers (${alive}/${total})`;
      }

      if (statQuestionsPlayed) {
        statQuestionsPlayed.textContent = questionsPlayed;
      }
      if (statQuestionsTotal) {
        statQuestionsTotal.textContent = totalQuestions;
      }
    }

    function renderPlayers() {
      const grid = document.getElementById('playerGrid');
      grid.innerHTML = '';

      playersState.forEach(p => {
        const div = document.createElement('div');
        div.className = 'player-square ' + (p.alive ? 'alive' : 'out');
        div.textContent = p.alive ? 'IN' : 'OUT';

        div.title = `${p.name} — ${p.alive ? 'In spel' : 'Uit'}`;

        grid.appendChild(div);
      });
    }

    function clearActiveTiles() {
      document
        .querySelectorAll('.question-tile.active')
        .forEach(t => t.classList.remove('active'));
    }

    socket.on('host:gameCreated', ({ gameCode, questions }) => {
      // Winner overlay resetten
      winnerOverlay.style.display = 'none';
      winnerTitle.textContent = 'We hebben een winnaar!';
      winnerNameLine.textContent = '';
      winnerReason.textContent = '';

      currentGameCode = gameCode;
      gameCodeSpan.textContent = gameCode;

      // Cache de vragen (incl. categorie & difficulty)
      questionsCache = (questions || []).map((q, i) => ({
        index: typeof q.index === 'number' ? q.index : i,
        category: q.category || 'Algemeen',
        difficulty: q.difficulty || '',
        used: !!q.used
      }));

      totalQuestions = questionsCache.length;
      questionsPlayed = 0;

      if (statQuestionsTotal) statQuestionsTotal.textContent = totalQuestions;
      if (statQuestionsPlayed) statQuestionsPlayed.textContent = questionsPlayed;

      // Reset spelers & stats
      playersState = [];
      renderPlayers();
      updateStats();

      currentQuestionText.textContent = 'Klik een vraag in het bord om te starten.';
      currentQuestionInfo.textContent = '';
      currentQuestionOptions.innerHTML = '';
      if (questionMeta) {
        questionMeta.textContent = '';
      }

      // Antwoord-voortgang resetten
      answerProgressSummary.textContent = '(0/0)';
      progressBarFill.style.width = '0%';
      progressBarFill.style.background = '#ef4444';
      pendingList.innerHTML = '';

      // Vragenbord opbouwen
      questionGrid.innerHTML = '';
      questionsCache.forEach((q, i) => {
        const tile = document.createElement('div');
        tile.className = 'question-tile';

        const diffClass = mapDifficultyToClass(q.difficulty);
        if (diffClass) tile.classList.add(diffClass);
        if (q.used) tile.classList.add('used');

        tile.dataset.index = q.index;

        tile.innerHTML = `
          <div style="font-weight:600;">${q.category}</div>
          <small style="opacity:0.8;">${q.difficulty}</small>
        `;

        tile.onclick = () => {
          if (!currentGameCode || tile.classList.contains('used')) return;
          clearActiveTiles();
          tile.classList.add('active');
          socket.emit('host:selectQuestion', {
            gameCode: currentGameCode,
            questionIndex: q.index
          });
        };

        questionGrid.appendChild(tile);
      });
    });

    socket.on('host:playersUpdate', ({ players }) => {
      playersState = players || [];
      renderPlayers();
      updateStats();
    });

    socket.on('question:new', ({ text, options }) => {
      currentQuestionText.textContent = text;
      questionMeta.textContent = '';

      if (btnCloseQuestionInline) btnCloseQuestionInline.style.display = 'inline-block';
      if (btnProcessAnswersInline) btnProcessAnswersInline.style.display = 'none';

      currentQuestionInfo.textContent = '';
      currentQuestionOptions.innerHTML = '';

      const totalAlive = playersState.filter(p => p.alive).length;
      answerProgressSummary.textContent = `(0/${totalAlive})`;
      progressBarFill.style.width = '0%';
      progressBarFill.style.background = '#ef4444';
      pendingList.innerHTML = '';

      if (options && options.length) {
        options.forEach((opt, idx) => {
          const row = document.createElement('div');
          row.className = 'option-row';
          row.innerHTML = `
            <div class="option-label">${String.fromCharCode(65 + idx)}</div>
            <div class="option-text">${opt}</div>
          `;
          currentQuestionOptions.appendChild(row);
        });
      }
    });

    socket.on('host:questionLocked', () => {
      if (btnCloseQuestionInline) btnCloseQuestionInline.style.display = 'none';
      if (btnProcessAnswersInline) btnProcessAnswersInline.style.display = 'inline-block';

      const meta = document.getElementById('questionMeta');
      if (meta) meta.textContent = 'Vraag gesloten - klaar om antwoorden te verwerken';
    });

    socket.on('question:results', ({ correctIndex, results, aliveCount }) => {
      questionMeta.textContent = `Vraag gesloten - nog ${aliveCount} spelers in het spel`;
      if (btnCloseQuestionInline) btnCloseQuestionInline.style.display = 'none';
      if (btnProcessAnswersInline) btnProcessAnswersInline.style.display = 'none';

      currentQuestionInfo.textContent = `Juiste antwoord: optie ${
        correctIndex + 1
      }. Antwoorden ontvangen: ${results.length}.`;

      const optionRows = currentQuestionOptions.querySelectorAll('.option-row');
      if (optionRows[correctIndex]) {
        optionRows[correctIndex].classList.add('correct');
      }

      updateStats();
    });

    socket.on('host:questionUsed', ({ index }) => {
      const tile = questionGrid.querySelector(`.question-tile[data-index="${index}"]`);
      if (tile && !tile.classList.contains('used')) {
        tile.classList.add('used');
        tile.classList.remove('active');
        questionsPlayed++;
        updateStats();
      }
    });

    socket.on('game:over', ({ reason, winner, winnerType }) => {
      questionMeta.textContent = 'Game afgelopen';

      let title = 'Game afgelopen';
      let nameLine = '';

      if (winnerType === 'player' && winner) {
        title = 'We hebben een winnaar!';
        nameLine = `Winnaar: ${winner}`;
      } else if (winnerType === 'host') {
        title = 'De host wint het spel';
      }

      winnerTitle.textContent = title;
      winnerNameLine.textContent = nameLine;
      winnerReason.textContent = reason || '';

      winnerOverlay.style.display = 'flex';
    });

    socket.on('host:pendingAnswers', ({ pending }) => {
      pendingList.innerHTML = '';

      const totalAlive = playersState.filter(p => p.alive).length;
      const remaining = pending.length;
      const answered = totalAlive - remaining;

      answerProgressSummary.textContent = `(${answered}/${totalAlive})`;

      const percentage = totalAlive > 0 ? (answered / totalAlive) * 100 : 0;
      progressBarFill.style.width = `${percentage}%`;

      if (percentage < 40) progressBarFill.style.background = '#ef4444';
      else if (percentage < 80) progressBarFill.style.background = '#f59e0b';
      else progressBarFill.style.background = '#22c55e';

      if (remaining === 0) {
        const li = document.createElement('li');
        li.textContent = 'Alle antwoorden binnen ✔️';
        li.style.color = '#22c55e';
        pendingList.appendChild(li);
        return;
      }

      pending.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        pendingList.appendChild(li);
      });
    });

    btnManageQuestions.onclick = () => {
      questionsFeedback.textContent = '';
      questionsJson.value = JSON.stringify(
        questionBankExample(),
        null,
        2
      );
      questionModal.style.display = 'flex';
    };

    btnCancelQuestions.onclick = () => {
      questionModal.style.display = 'none';
    };

    // Vragen toevoegen (append) via JSON
    btnApplyQuestions.onclick = () => {
      questionsFeedback.textContent = '';
      let parsed;
      try {
        parsed = JSON.parse(questionsJson.value);
      } catch (e) {
        questionsFeedback.style.color = '#f97373';
        questionsFeedback.textContent = 'JSON is ongeldig. Controleer je haakjes en komma’s.';
        return;
      }

      // Sta zowel één object als een array toe
      const questions = Array.isArray(parsed) ? parsed : [parsed];

      socket.emit('host:addQuestions', { questions });
    };

    // Alle vragen verwijderen
    btnClearQuestions.onclick = () => {
      const ok = confirm(
        "Weet je zeker dat je ALLE vragen wilt verwijderen?\nDit heeft effect op nieuwe games, niet op games die al lopen."
      );
      if (!ok) return;
      socket.emit('host:clearQuestions');
    };

    socket.on('host:questionsUpdated', ({ count }) => {
      questionsFeedback.style.color = '#22c55e';
      questionsFeedback.textContent = `Vragen succesvol bijgewerkt. Totaal aantal vragen: ${count}. Start een nieuwe game om ze te gebruiken.`;
    });

    socket.on('host:error', (msg) => {
      if (questionModal.style.display === 'flex') {
        questionsFeedback.style.color = '#f97373';
        questionsFeedback.textContent = msg;
      } else {
        alert(msg);
      }
    });
    const btnGenerateAiQuestions = document.getElementById('btnGenerateAiQuestions');

  btnGenerateAiQuestions.onclick = async () => {
    questionsFeedback.style.color = '#e5e7eb';
    questionsFeedback.textContent = 'AI is nieuwe vragen aan het bedenken...';

    try {
      const response = await fetch('/api/generate-questions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          count: 6
        })
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error || 'Onbekende fout bij genereren.');
      }

      const data = await response.json();
      const questions = data.questions || [];

      if (!Array.isArray(questions) || !questions.length) {
        throw new Error('Geen vragen ontvangen van AI.');
      }


      questionsJson.value = JSON.stringify(questions, null, 2);

      questionsFeedback.style.color = '#22c55e';
      questionsFeedback.textContent = `AI heeft ${questions.length} vragen gegenereerd. Controleer ze en klik op "Vragen toevoegen".`;
    } catch (e) {
      console.error(e);
      questionsFeedback.style.color = '#f97373';
      questionsFeedback.textContent = `Fout bij genereren van AI-vragen: ${e.message}`;
    }
  };
  </script>
</body>
</html>